version: 2.1

references:
  workspace_root: &workspace_root
    ~/blog.sugarshin.net
  filter_gh_pages: &filter_gh_pages
    filters:
      branches:
        ignore: gh-pages

orbs:
  slack: circleci/slack@3.4.2
  gh-pages: sugarshin/gh-pages@0.0.6
  npm: sugarshin/npm@0.1.5

executors:
  nodejs:
    working_directory: *workspace_root
    docker:
      - image: circleci/node:12.6.0
        environment:
          TZ: "Asia/Tokyo"
  nodejs_browsers:
    working_directory: *workspace_root
    docker:
      - image: circleci/node:12.6.0-browsers
        environment:
          TZ: "Asia/Tokyo"
  playwright_base:
    working_directory: *workspace_root
    docker:
      - image: sugarshin/playwright-base:2.1.0-node12
        environment:
          TZ: "Asia/Tokyo"
  buildpack_deps:
    working_directory: *workspace_root
    docker:
      - image: circleci/buildpack-deps:stable

commands:
  build_prod_assets:
    steps:
      - run:
          name: Build Assets
          command: npm run build
          environment:
            NODE_ENV: production
      - run:
          name: Prerender
          command: bin/react-snap --cns

jobs:
  lint_unittest:
    executor: nodejs
    steps:
      - checkout
      - npm/install:
          yarn: true
          cache-key: 'cache-{{ checksum "yarn.lock" }}'
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Test
          command: npm run test:coverage
      - run:
          name: Coverage Report
          command: npm run codecov
      - persist_to_workspace:
          root: *workspace_root
          paths:
            - node_modules

  e2e_test:
    executor: playwright_base
    steps:
      - checkout
      - attach_workspace:
          at: *workspace_root
      - run:
          command: npm run build:e2e-test
          environment:
            NODE_ENV: production
      - run:
          command: node static-serve
          background: true
          environment:
            PORT: '3000'
            DIR: build-e2e-test
      - run: npx wait-on@5 http-get://localhost:3000
      - run:
          command: npm run e2e-test:ci
          environment:
            BASE_URL: http://localhost:3000
            ARTIFACTS_DIR: e2e-test-artifacts
      - store_artifacts:
          path: e2e-test-artifacts
          destination: e2e-test-artifacts

  build:
    executor: nodejs_browsers
    steps:
      - checkout
      - attach_workspace:
          at: *workspace_root
      - build_prod_assets
      - store_artifacts:
          path: build
          destination: build
      - persist_to_workspace:
          root: *workspace_root
          paths:
            - build

  notify_slack:
    machine: true
    steps:
      - slack/notify:
          message: "Blog has been updated! <https://blog.sugarshin.net>"
          mentions: "${SLACK_UUID}"
          webhook: ${SLACK_WEBHOOK_URL}

workflows:
  test_build_deploy_notify:
    jobs:
      - lint_unittest:
          <<: *filter_gh_pages
      - e2e_test:
          <<: *filter_gh_pages
          requires:
            - lint_unittest
      - build:
          <<: *filter_gh_pages
          requires:
            - e2e_test
      - gh-pages/deploy:
          name: deploy
          executor: buildpack_deps
          build-dir: build
          attach-workspace: true
          workspace-root: *workspace_root
          git-user: CircleCI
          git-email: s+circleci@sugarshin.net
          ssh-fingerprints: 4f:c7:c2:20:07:b5:11:84:75:b4:e5:94:73:48:9b:4b
          requires:
            - build
          filters:
            branches:
              only: master
      - notify_slack:
          requires:
            - deploy
